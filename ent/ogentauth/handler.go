

// Code generated by ogent-auth, DO NOT EDIT.
package ogentauth

import (
  "context"
  "errors"
  "github.com/tiagoposse/connect/ent/ogent"

  sessions "github.com/tiagoposse/go-auth/sessions"
  authz "github.com/tiagoposse/go-auth/authorization"
)

type ISessionHandler interface {
  ValidateApiKeyAuth(context.Context, string) (authz.ScopedSession, error)
  ValidateCookieAuth(context.Context, string) (authz.ScopedSession, error)

  CreateSessionToken(context.Context, any) (string, error)
  ValidateSessionToken(context.Context, string) (authz.ScopedSession, error)
}

type SecurityHandler struct {
  ISessionHandler
}

func NewSecurityHandler(sess ISessionHandler) *SecurityHandler {
  return &SecurityHandler{
    ISessionHandler: sess,
  }
}


func (h *SecurityHandler) HandleApiKeyAuth(c context.Context, operationName string, t ogent.ApiKeyAuth) (context.Context, error) {
  session, err := h.ValidateApiKeyAuth(c, t.APIKey)
	if err != nil {
		return c, err
	}

  ctx := context.WithValue(c, sessions.ContextSessionKey{}, session)
  if err := ValidateScopes(operationName, session.GetScopes()); err != nil {
    return ctx, err
  }

	return ctx, nil
}

func (h *SecurityHandler) HandleCookieAuth(c context.Context, operationName string, t ogent.CookieAuth) (context.Context, error) {
  session, err := h.ValidateCookieAuth(c, t.APIKey)
	if err != nil {
		return c, err
	}

  ctx := context.WithValue(c, sessions.ContextSessionKey{}, session)
  if err := ValidateScopes(operationName, session.GetScopes()); err != nil {
    return ctx, err
  }

	return ctx, nil
}


func ValidateScopes(operationName string, reqScopes authz.Scopes) error {
  if opScopes, ok := scopes[operationName]; ok {
    found := false
    for _, reqScope := range reqScopes {
      for _, opScope := range opScopes {
        if reqScope == opScope {
          found = true
          break
        }
      }
      if found {
        break
      }
    }

    if !found {
      return errors.New("no scopes match")
    }
  }

  return nil
}

var scopes map[string]authz.Scopes = map[string]authz.Scopes{
  "createApiKey": {
    "admin.*",
    "user.*",
    "user.apikey.write",
  },
  "createApiKeyUser": {
    "admin.*",
    "user.*",
    "user.apikey.write",
  },
  "createDevice": {
    "admin.*",
    "admin.groups.write",
    "user.*",
    "user.devices.write",
  },
  "createDeviceUser": {
    "admin.*",
    "admin.groups.write",
    "user.*",
    "user.devices.write",
  },
  "createGroup": {
    "admin.*",
    "admin.devices.write",
  },
  "createGroupUsers": {
    "admin.*",
    "admin.devices.write",
  },
  "createUser": {
    "admin.*",
    "admin.users.write",
  },
  "createUserAudit": {
    "admin.*",
    "admin.users.write",
  },
  "createUserDevices": {
    "admin.*",
    "admin.users.write",
  },
  "createUserGroup": {
    "admin.*",
    "admin.users.write",
  },
  "createUserKeys": {
    "admin.*",
    "admin.users.write",
  },
  "deleteApiKey": {
    "admin.*",
    "user.*",
    "user.apikey.write",
  },
  "deleteApiKeyUser": {
    "admin.*",
    "user.*",
    "user.apikey.write",
  },
  "googleAuthSync": {
    "admin.*",
    "admin.sso.*",
    "admin.sso.sync",
  },
  "listApiKey": {
    "admin.*",
    "user.*",
    "user.apikey.write",
  },
  "listApiKeyUser": {
    "admin.*",
    "user.*",
    "user.apikey.write",
  },
  "listAudit": {
    "admin.*",
    "admin.audit.readonly",
  },
  "listAuditUser": {
    "admin.*",
    "admin.audit.readonly",
  },
  "logout": {
  },
  "readApiKey": {
    "admin.*",
    "user.*",
    "user.apikey.write",
  },
  "readApiKeyUser": {
    "admin.*",
    "user.*",
    "user.apikey.write",
  },
  "status": {
  },
  "updateApiKey": {
    "admin.*",
    "user.*",
    "user.apikey.write",
  },
  "updateApiKeyUser": {
    "admin.*",
    "user.*",
    "user.apikey.write",
  },
}
